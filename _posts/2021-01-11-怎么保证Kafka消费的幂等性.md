## 怎么保证消费的幂等性

#### 什么是幂等性和重复消费？

你消费了一条消息后，为了告知Kafka你完成了本次消费，于是开始提交这条消息的offset。但是，在你提交前你突然宕机了，于是等你宕机恢复后并且重新向Kafka消费消息时，Kafka还是会把这条消息发给你，于是这条信息被你重复消费了。

<br>

#### 为什么要幂等性？

如果你消费的消息表示某人的账户余额要加10元，那你就希望消费这条消息时能够实现幂等性。

<br>

#### 怎么保证消费的幂等性？

主要还是得结合业务。

- 有的消息天然幂等，不需要额外处理。比如你对Redis进行set。
- 拿个数据要写库时，如果有唯一键约束就直接插入；否则你先根据主键查一下，如果这数据都有了，就把insert改为update。
- 对于复杂一点的场景：你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西。消费时先根据这个 id 去比如 Redis 里查一下之前消费过吗？如果没有消费过，你就处理，然后把这个 id 写 Redis。如果消费过了，就别处理了。